{% extends 'core/base.html' %}
{% block title %}Ceklis Seiscomp Form{% endblock %}

{% block content %}
<div class="form-container">
    <div class="container">
        <h1 class="page-header">Ceklis Seiscomp Form</h1>
        <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}
            {% load form_tags %}

            {% if form.errors %}
            <div id="form-errors" data-errors="true" style="display: none;">
                {% for field in form %}
                {% if field.errors %}
                {% for error in field.errors %}
                <div data-field="{{ field.id_for_label }}" data-error="{{ error|escapejs }}"></div>
                {% endfor %}
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            <div class="form-group row">
                <div class="form-group col-md-4">
                    {{ form.kelompok.label_tag }}
                    {{ form.kelompok|add_class:"form-select" }}
                    <div class="invalid-feedback">
                        Please provide a valid kelompok.
                    </div>
                </div>
                <div class="col-md-4">
                    {{ form.date.label_tag }}
                    <div class="input-group">
                        {{ form.date|add_class:"form-control date-picker" }}
                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                    </div>
                    <div class="invalid-feedback">
                        Please provide a valid date.
                    </div>
                </div>
                <div class="col-md-4">
                    {{ form.shift.label_tag }}
                    {{ form.shift|add_class:"form-select" }}
                    <div class="invalid-feedback">
                        Please provide a valid Shift.
                    </div>
                </div>
                <div class="col-md-4">
                    {{ form.jam_pelaksanaan.label_tag }}
                    {{ form.jam_pelaksanaan|add_class:"form-select" }}
                    <div class="invalid-feedback">
                        Please provide a valid jam pelaksanaan.
                    </div>
                </div>
                <div class="col-md-4">
                    {{ form.operator.label_tag }}
                    {{ form.operator|add_class:"form-select" }}
                    <div class="invalid-feedback">
                        Please provide a valid operator.
                    </div>
                </div>
                <div class="col-md-4">
                    {{ form.cs_id.label_tag }}
                    <input type="text" name="{{ form.cs_id.name }}" value="{{ form.cs_id.value|default:'' }}"
                        class="form-control bg-light" id="{{ form.cs_id.id_for_label }}" readonly
                        style="cursor: not-allowed;">
                    <div class="invalid-feedback">
                        Please provide a valid CS ID.
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <div class="form-group col-md-12">
                    <button type="button" class="btn btn-primary" id="fetchDataButton">Fetch gaps and blanks</button>
                    &emsp;
                    <input type="checkbox" id="fetchSpikesCheckbox">
                    &nbsp;
                    <label>Deteksi <i>baseline shift spikes</i> (eksperimental)</p>
                </div>
                <div class="form-group col-md-12">
                    <p id="last_update">Last Update: </p>
                </div>
                <script>
                    document.getElementById('fetchDataButton').addEventListener('click', function () {
                        fetch(`{% url 'cl_seiscomp:fetch_gaps_blanks' %}`)
                            .then(response => response.text())
                            .then(data => {
                                const spikesFetch = document.getElementById("fetchSpikesCheckbox").checked;
                                const gapsField = document.getElementById('{{ form.gaps.id_for_label }}');
                                const blanksField = document.getElementById('{{ form.blanks.id_for_label }}');
                                const spikesField = document.getElementById('{{ form.spikes.id_for_label }}');
                                const lastUpdate = document.getElementById('last_update');
                                data = JSON.parse(data);
                                lastUpdate.innerHTML = `Last Update: <strong>${data.last_update}</strong>`;
                                gapsField.value = data.gaps;
                                blanksField.value = data.blanks;
                                spikesField.value = spikesFetch ? data.spikes : [];
                            })
                            .catch(error => console.error('Error fetching data:', error));
                    });
                </script>
            </div>
            <div class="form-group row">
                <div class="form-group col-md-4">
                    {{ form.gaps.label_tag }}
                    {{ form.gaps|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please provide a valid gaps.
                    </div>
                </div>
                <div class="form-group col-md-4">
                    {{ form.spikes.label_tag }}
                    {{ form.spikes|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please provide a valid spikes.
                    </div>
                </div>
                <div class="form-group col-md-4">
                    {{ form.blanks.label_tag }}
                    {{ form.blanks|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please provide a valid blanks.
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <div class="form-group col-md-4">
                    {{ form.slmon.label_tag }}
                    {{ form.slmon|add_class:"form-control" }}
                    <div class="invalid-feedback">
                        Please provide a valid slmon.
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="slmon_image">Upload SLMon Image:</label>
                <input type="file" name="slmon_image" id="slmon_image" class="form-control">
                {% if form.instance.slmon_image %}
                <div class="mt-2">
                    <a href="{{ form.instance.slmon_image.url }}" target="_blank">View current image</a>
                </div>
                <img id="pasted_image" src="{{ form.instance.slmon_image.url }}"
                    style="max-width: 100%; margin-top: 10px;">
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" name="clear_image" id="clear_image">
                    <label class="form-check-label" for="clear_image">
                        Clear current image
                    </label>
                </div>
                {% else %}
                <div id="drop_zone" class="border border-primary border-4 p-3 mt-2 text-center rounded"
                    style="background-color: #f8f9fa;">
                    <p class="mb-0">Drag and drop an image here or press <strong>Ctrl+V</strong> to paste</p>
                </div>
                <img id="pasted_image" style="display:none; max-width: 100%; margin-top: 10px;">
                {% endif %}
            </div>

            <button type="submit" class="btn btn-primary">Save</button>
            <a href="{% url 'cl_seiscomp:cs_list' %}" class="btn btn-secondary">Cancel</a>
        </form>

        <script>

            // date picker initialization
            (function () {
                const dateInput = document.getElementById('{{ form.date.id_for_label }}');
                dateInput.type = 'date';

                // change cs_id value based on date_input and waktu_dinas
                const waktuDinasSelect = document.getElementById('{{ form.shift.id_for_label }}');
                const qcIdInput = document.getElementById('{{ form.cs_id.id_for_label }}');
                const jamPelaksanaanSelect = document.getElementById('{{ form.jam_pelaksanaan.id_for_label }}');

                // Helper for CS ID suffix
                function getCsSuffix(waktuDinasValue) {
                    switch (waktuDinasValue) {
                        case 'Dini Hari':
                            return '1D';
                        case 'Pagi':
                            return '2P';
                        case 'Siang':
                            return '3S';
                        case 'Malam':
                            return '4M';
                        default:
                            return '';
                    }
                }

                function updateQcId() {
                    const dateValue = dateInput.value;
                    const waktuDinasValue = waktuDinasSelect.value;
                    qcIdInput.value = "CS-" + dateValue + "-" + getCsSuffix(waktuDinasValue);
                }

                function updateJamPelaksanaan() {
                    const shiftValue = waktuDinasSelect.value;
                    let jamPelaksanaanValue = "";
                    if (shiftValue === "Pagi") {
                        jamPelaksanaanValue = "12:00 WIB";
                    } else if (shiftValue === "Siang") {
                        jamPelaksanaanValue = "18:00 WIB";
                    } else if (shiftValue === "Malam") {
                        jamPelaksanaanValue = "00:00 WIB";
                    } else {
                        jamPelaksanaanValue = "06:00 WIB";
                    }
                    jamPelaksanaanSelect.value = jamPelaksanaanValue;
                }

                dateInput.addEventListener('change', updateQcId);
                waktuDinasSelect.addEventListener('change', function () {
                    updateQcId();
                    updateJamPelaksanaan();
                });

                // Initialize cs_id and jam_pelaksanaan based on the default values
                updateQcId();
                updateJamPelaksanaan();
            })();

            // Paste functionality
            document.addEventListener('paste', function (event) {
                const items = event.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        const reader = new FileReader();
                        reader.onload = function (event) {
                            const imgElement = document.getElementById('pasted_image');
                            imgElement.src = event.target.result;
                            imgElement.style.display = 'block';
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            document.getElementById('slmon_image').files = dataTransfer.files;
                            document.getElementById('drop_zone').style.display = 'none';
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });

            // Drag and drop functionality
            const dropZone = document.getElementById('drop_zone');
            dropZone.addEventListener('dragover', function (event) {
                event.preventDefault();
                event.stopPropagation();
                dropZone.classList.add('bg-light');
            });

            dropZone.addEventListener('dragleave', function (event) {
                event.preventDefault();
                event.stopPropagation();
                dropZone.classList.remove('bg-light');
            });

            dropZone.addEventListener('drop', function (event) {
                event.preventDefault();
                event.stopPropagation();
                dropZone.classList.remove('bg-light');
                const file = event.dataTransfer.files[0];
                if (file && file.type.indexOf('image') !== -1) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const imgElement = document.getElementById('pasted_image');
                        imgElement.src = event.target.result;
                        imgElement.style.display = 'block';
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        document.getElementById('slmon_image').files = dataTransfer.files;
                        dropZone.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });
        </script>
    </div>
</div>
<script>
    // Handle form validation errors
    document.addEventListener('DOMContentLoaded', function () {
        const formErrors = document.getElementById('form-errors');
        if (formErrors && formErrors.dataset.errors === 'true') {
            // Get the error modal element
            const errorModalElement = document.getElementById('errorModal');
            if (errorModalElement) {
                // Initialize the Bootstrap 5 modal
                const errorModal = new bootstrap.Modal(errorModalElement, {
                    backdrop: true, // Enable backdrop click to close
                    keyboard: true  // Enable ESC key to close
                });

                const errorContent = document.getElementById('errorModalContent');

                if (errorContent) {
                    let errorHtml = '<p>Silakan perbaiki kesalahan berikut:</p><ul class="mb-0">';

                    // Get all error elements
                    const errorElements = formErrors.querySelectorAll('[data-field][data-error]');
                    if (errorElements.length > 0) {
                        errorElements.forEach(el => {
                            const fieldId = el.dataset.field;
                            const errorMsg = el.dataset.error;
                            const fieldLabel = document.querySelector(`label[for="${fieldId}"]`);
                            const labelText = fieldLabel ? fieldLabel.textContent.trim().replace(':', '') : fieldId;
                            errorHtml += `<li><strong>${labelText}:</strong> ${errorMsg}</li>`;
                        });
                    } else {
                        // Fallback if no specific field errors found
                        errorHtml += '<li>Terjadi kesalahan saat memproses formulir.</li>';
                    }

                    errorHtml += '</ul>';
                    errorContent.innerHTML = errorHtml;

                    // Show the modal
                    errorModal.show();

                    // Manually handle close button click
                    const closeButtons = errorModalElement.querySelectorAll('[data-bs-dismiss="modal"]');
                    closeButtons.forEach(button => {
                        button.addEventListener('click', function () {
                            errorModal.hide();
                        });
                    });
                }
            }
        }
    });
</script>
{% endblock %}